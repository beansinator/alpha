<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Forest Stable Build</title>
<style>
body{margin:0;background:black;overflow:hidden;}
canvas{width:100vw;height:100vh;image-rendering:pixelated;cursor:none;}
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

const W=320,H=180;
canvas.width=W;canvas.height=H;

let state="menu";
canvas.onclick=()=>{
  if(state==="menu"){
    state="game";
    canvas.requestPointerLock();
  }
};

//////////////////////////////////////////////////
// SAFE SAVE SYSTEM
//////////////////////////////////////////////////
function save(){
  try{
    localStorage.setItem("forest_save",JSON.stringify({
      player,trees
    }));
  }catch(e){}
}

function load(){
  try{
    let s=localStorage.getItem("forest_save");
    if(!s)return;
    let data=JSON.parse(s);
    if(data.player) Object.assign(player,data.player);
    if(data.trees) trees=data.trees;
  }catch(e){}
}

//////////////////////////////////////////////////
// MAP
//////////////////////////////////////////////////
const SIZE=24;
let map=[];
for(let y=0;y<SIZE;y++){
  let row=[];
  for(let x=0;x<SIZE;x++){
    row.push(x===0||y===0||x===SIZE-1||y===SIZE-1?1:0);
  }
  map.push(row);
}

map[2][2]=2;               // shop
map[SIZE-3][SIZE-3]=3;     // sell
map[16][16]=4;             // cave wall marker

//////////////////////////////////////////////////
// PLAYER
//////////////////////////////////////////////////
let player={
  x:5,y:5,dir:0,fov:Math.PI/3,
  wood:0,money:0,
  hearts:4,maxHearts:4
};

//////////////////////////////////////////////////
// TREES
//////////////////////////////////////////////////
let trees=[];
for(let i=0;i<40;i++){
  trees.push({
    x:2+Math.random()*(SIZE-4),
    y:2+Math.random()*(SIZE-4),
    alive:true,
    grow:0
  });
}

//////////////////////////////////////////////////
// SLIME (PINK)
//////////////////////////////////////////////////
let slime={x:18,y:18};

//////////////////////////////////////////////////
let keys={},time=0;
document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
document.addEventListener("mousemove",e=>{
  if(document.pointerLockElement===canvas && state==="game")
    player.dir+=e.movementX*0.002;
});

//////////////////////////////////////////////////
// COLLISION SAFE
//////////////////////////////////////////////////
function isWall(x,y){
  let tx=Math.floor(x);
  let ty=Math.floor(y);
  if(tx<0||ty<0||tx>=SIZE||ty>=SIZE) return true;
  return map[ty][tx]===1;
}

function move(dx,dy){
  let nx=player.x+dx;
  let ny=player.y+dy;
  if(!isWall(nx,player.y)) player.x=nx;
  if(!isWall(player.x,ny)) player.y=ny;
}

//////////////////////////////////////////////////
// CLICK ACTION
//////////////////////////////////////////////////
document.addEventListener("click",()=>{
  if(state!=="game") return;

  trees.forEach(t=>{
    if(!t.alive)return;
    let dx=t.x-player.x;
    let dy=t.y-player.y;
    let dist=Math.hypot(dx,dy);
    let ang=Math.atan2(dy,dx)-player.dir;
    if(dist<1.6 && Math.abs(ang)<0.4){
      t.alive=false;
      player.wood+=5;
    }
  });
});

//////////////////////////////////////////////////
// UPDATE
//////////////////////////////////////////////////
function update(){
  if(state!=="game") return;

  const sp=0.07;
  if(keys["w"]) move(Math.cos(player.dir)*sp,Math.sin(player.dir)*sp);
  if(keys["s"]) move(-Math.cos(player.dir)*sp,-Math.sin(player.dir)*sp);
  if(keys["a"]) move(Math.cos(player.dir-Math.PI/2)*sp,Math.sin(player.dir-Math.PI/2)*sp);
  if(keys["d"]) move(Math.cos(player.dir+Math.PI/2)*sp,Math.sin(player.dir+Math.PI/2)*sp);

  let tile=map[Math.floor(player.y)][Math.floor(player.x)];
  if(tile===3 && player.wood>0){
    player.money+=player.wood;
    player.wood=0;
  }

  // SAFE slime movement
  let dx=player.x-slime.x;
  let dy=player.y-slime.y;
  let dist=Math.hypot(dx,dy);
  if(dist>0.01 && dist<8){
    slime.x+=dx/dist*0.02;
    slime.y+=dy/dist*0.02;
  }
  if(dist<0.7){
    player.hearts-=0.01;
    if(player.hearts<=0){
      state="menu";
      player.hearts=player.maxHearts;
      player.x=5;player.y=5;
    }
  }

  // TREE REGROW SAFE
  trees.forEach(t=>{
    if(!t.alive){
      t.grow+=0.001;
      if(t.grow>1){
        t.alive=true;
        t.grow=0;
      }
    }
  });

  time+=0.002;
  if(Math.random()<0.002) save();
}

//////////////////////////////////////////////////
// RAYCAST SAFE
//////////////////////////////////////////////////
function castRays(){
  for(let x=0;x<W;x++){
    let angle=player.dir-player.fov/2+(x/W)*player.fov;
    let dist=0;
    let hit=false;

    while(!hit && dist<30){
      dist+=0.05;
      let rx=Math.floor(player.x+Math.cos(angle)*dist);
      let ry=Math.floor(player.y+Math.sin(angle)*dist);

      if(rx<0||ry<0||rx>=SIZE||ry>=SIZE){
        hit=true;
        break;
      }

      if(map[ry][rx]===1) hit=true;
    }

    if(dist<=0.01) dist=0.01;

    let h=H/(dist);
    ctx.fillStyle="darkgreen";
    ctx.fillRect(x,H/2-h/2,1,h);
  }
}

//////////////////////////////////////////////////
// SPRITES SAFE
//////////////////////////////////////////////////
function drawSprites(){

  let sprites=[];

  trees.forEach(t=>{
    if(!t.alive)return;
    let dx=t.x-player.x;
    let dy=t.y-player.y;
    let dist=Math.hypot(dx,dy);
    if(dist<0.1) return;
    let ang=Math.atan2(dy,dx)-player.dir;
    sprites.push({type:"tree",dist,ang});
  });

  let dx=slime.x-player.x;
  let dy=slime.y-player.y;
  let dist=Math.hypot(dx,dy);
  if(dist>0.1)
    sprites.push({type:"slime",dist,ang:Math.atan2(dy,dx)-player.dir});

  sprites.sort((a,b)=>b.dist-a.dist);

  sprites.forEach(s=>{
    if(Math.abs(s.ang)<player.fov/2){
      let size=H/(s.dist);
      let screenX=(s.ang+player.fov/2)/player.fov*W;
      if(s.type==="tree"){
        ctx.fillStyle="brown";
        ctx.fillRect(screenX-size/6,H/2-size/2,size/3,size);
        ctx.fillStyle="green";
        ctx.fillRect(screenX-size/2,H/2-size,size,size/2);
      }
      if(s.type==="slime"){
        ctx.fillStyle="pink";
        ctx.fillRect(screenX-size/2,H/2-size/2,size,size/2);
      }
    }
  });
}

//////////////////////////////////////////////////
// HUD + TORCH
//////////////////////////////////////////////////
function drawHUD(){
  for(let i=0;i<player.maxHearts;i++){
    ctx.fillStyle=i<player.hearts?"red":"darkred";
    ctx.fillRect(10+i*15,10,10,10);
  }
  ctx.fillStyle="white";
  ctx.font="12px monospace";
  ctx.fillText("WOOD:"+player.wood,10,H-20);
  ctx.fillText("$:"+player.money,140,H-20);

  // torch
  ctx.fillStyle="brown";
  ctx.fillRect(20,H-70,8,30);
  ctx.fillStyle="orange";
  ctx.fillRect(18,H-80,12,12);
}

//////////////////////////////////////////////////
function drawMenu(){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,W,H);
  ctx.fillStyle="white";
  ctx.font="20px monospace";
  ctx.fillText("FOREST STABLE",80,80);
  ctx.font="12px monospace";
  ctx.fillText("CLICK TO START",100,110);
}

//////////////////////////////////////////////////
function render(){
  if(state==="menu"){drawMenu();return;}

  ctx.fillStyle="#87CEEB";
  ctx.fillRect(0,0,W,H/2);
  ctx.fillStyle="#355e0b";
  ctx.fillRect(0,H/2,W,H/2);

  castRays();
  drawSprites();
  drawHUD();
}

load();
function loop(){update();render();requestAnimationFrame(loop);}
loop();
</script>
</body>
</html>
